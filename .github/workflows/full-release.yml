name: Full Release (Android + iOS)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'production'
        type: choice
        options:
          - preview
          - production
      submit_android:
        description: 'Submit to Google Play Store'
        required: false
        default: false
        type: boolean
      submit_ios:
        description: 'Submit to App Store Connect'
        required: false
        default: false
        type: boolean
      version_bump:
        description: 'Version bump type (only for production)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '20'
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Get current version
        id: version
        run: |
          VERSION=$(jq -r '.expo.version' app.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Validate app.json
        run: |
          jq '.' app.json > /dev/null
          echo "app.json is valid JSON"

  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint --if-present
        continue-on-error: true

      - name: Run TypeScript check
        run: npx tsc --noEmit --skipLibCheck
        continue-on-error: true

      - name: Run tests
        run: npm test -- --passWithNoTests
        continue-on-error: true

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: lint-and-test
    outputs:
      build-url: ${{ steps.build.outputs.build-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=${{ github.event.inputs.profile || 'production' }}" >> $GITHUB_OUTPUT
          fi

      - name: Build Android app
        id: build
        run: |
          BUILD_OUTPUT=$(eas build --platform android --profile ${{ steps.profile.outputs.profile }} --non-interactive --json)
          BUILD_URL=$(echo $BUILD_OUTPUT | jq -r '.[0].buildUrl // empty')
          echo "build-url=$BUILD_URL" >> $GITHUB_OUTPUT

  build-ios:
    name: Build iOS
    runs-on: ubuntu-latest
    needs: lint-and-test
    outputs:
      build-url: ${{ steps.build.outputs.build-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=${{ github.event.inputs.profile || 'production' }}" >> $GITHUB_OUTPUT
          fi

      - name: Build iOS app
        id: build
        run: |
          BUILD_OUTPUT=$(eas build --platform ios --profile ${{ steps.profile.outputs.profile }} --non-interactive --json)
          BUILD_URL=$(echo $BUILD_OUTPUT | jq -r '.[0].buildUrl // empty')
          echo "build-url=$BUILD_URL" >> $GITHUB_OUTPUT

  submit-android:
    name: Submit Android to Play Store
    runs-on: ubuntu-latest
    needs: build-android
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.submit_android == 'true') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Submit to Google Play Store
        run: eas submit --platform android --profile production --non-interactive --latest

  submit-ios:
    name: Submit iOS to App Store
    runs-on: ubuntu-latest
    needs: build-ios
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.submit_ios == 'true') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Submit to App Store Connect
        run: eas submit --platform ios --profile production --non-interactive --latest
        env:
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## ChefSpAIce ${{ github.ref_name }}
            
            ### Build Links
            - **Android Build:** ${{ needs.build-android.outputs.build-url }}
            - **iOS Build:** ${{ needs.build-ios.outputs.build-url }}
            
            ### Downloads
            View and download builds from the [Expo Dashboard](https://expo.dev/accounts/dtreg1/projects/chefspaice/builds)
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [prepare, build-android, build-ios]
    if: always() && (needs.build-android.result == 'success' || needs.build-ios.result == 'success')
    steps:
      - name: Release Summary
        run: |
          echo "## Full Release Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Build URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.build-android.result == 'success' && '✅ Success' || '❌ Failed' }} | ${{ needs.build-android.outputs.build-url || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.build-ios.result == 'success' && '✅ Success' || '❌ Failed' }} | ${{ needs.build-ios.outputs.build-url || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View all builds in the [Expo Dashboard](https://expo.dev/accounts/dtreg1/projects/chefspaice/builds)" >> $GITHUB_STEP_SUMMARY
