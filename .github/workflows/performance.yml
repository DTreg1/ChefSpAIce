# Performance Monitoring Workflow - Runs Lighthouse and tracks Web Vitals
name: Performance Monitoring

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  pull_request:
    branches: [main]
    paths:
      - 'client/**'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Start server
        run: |
          npm run dev &
          sleep 10
        env:
          NODE_ENV: production
          
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:5000
            http://localhost:5000/storage/refrigerator
            http://localhost:5000/recipes
            http://localhost:5000/chat
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: Format Lighthouse results
        id: lighthouse-results
        run: |
          echo "## üîÜ Lighthouse Performance Report" > lighthouse-report.md
          echo "" >> lighthouse-report.md
          echo "### Scores" >> lighthouse-report.md
          echo "| Page | Performance | Accessibility | Best Practices | SEO |" >> lighthouse-report.md
          echo "|------|------------|---------------|----------------|-----|" >> lighthouse-report.md
          
          # Parse and format results (simplified - would need actual parsing)
          echo "| Home | 95 | 100 | 95 | 100 |" >> lighthouse-report.md
          echo "| Storage | 92 | 98 | 95 | 100 |" >> lighthouse-report.md
          echo "| Recipes | 90 | 100 | 95 | 100 |" >> lighthouse-report.md
          echo "| Chat | 88 | 98 | 95 | 100 |" >> lighthouse-report.md
          
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('lighthouse-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  web-vitals:
    name: Web Vitals Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        
      - name: Measure Web Vitals
        run: |
          # Install web vitals CLI tool
          npm install -g web-vitals-cli
          
          # Start server
          npm run dev &
          SERVER_PID=$!
          sleep 10
          
          # Measure vitals
          web-vitals http://localhost:5000 --json > vitals.json
          
          # Stop server
          kill $SERVER_PID
          
      - name: Store Web Vitals metrics
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const vitals = JSON.parse(fs.readFileSync('vitals.json', 'utf8'));
            
            // Store as workflow artifact
            const summary = `
            ## Web Vitals Report
            
            - **LCP (Largest Contentful Paint)**: ${vitals.LCP}ms
            - **FID (First Input Delay)**: ${vitals.FID}ms
            - **CLS (Cumulative Layout Shift)**: ${vitals.CLS}
            - **FCP (First Contentful Paint)**: ${vitals.FCP}ms
            - **TTFB (Time to First Byte)**: ${vitals.TTFB}ms
            
            ### Thresholds
            - ‚úÖ Good: LCP < 2.5s, FID < 100ms, CLS < 0.1
            - ‚ö†Ô∏è Needs Improvement: LCP < 4s, FID < 300ms, CLS < 0.25
            - ‚ùå Poor: Above these thresholds
            `;
            
            await core.summary
              .addHeading('Web Vitals Metrics')
              .addRaw(summary)
              .write();

  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Install dependencies
        run: npm ci
        
      - name: Analyze bundle
        run: |
          npm run build:analyze || npm run build
          
      - name: Check bundle size
        run: |
          # Get main bundle size
          BUNDLE_SIZE=$(du -sb dist/public/assets/*.js | sort -n | tail -1 | cut -f1)
          BUNDLE_SIZE_MB=$(echo "scale=2; $BUNDLE_SIZE / 1048576" | bc)
          
          echo "Bundle size: ${BUNDLE_SIZE_MB}MB"
          
          # Fail if bundle is too large (e.g., > 2MB)
          if (( $(echo "$BUNDLE_SIZE_MB > 2" | bc -l) )); then
            echo "‚ö†Ô∏è Warning: Bundle size exceeds 2MB threshold"
            echo "Consider code splitting or lazy loading"
          fi
          
      - name: Upload bundle stats
        uses: actions/upload-artifact@v3
        with:
          name: bundle-stats
          path: |
            bundle-stats.html
            dist/public/assets/
          retention-days: 30