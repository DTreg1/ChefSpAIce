name: Bundle Size Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual triggering

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build production bundle
        run: npm run build

      - name: Build and analyze bundle with visualizer
        run: npx vite build --config vite.analyze.config.ts

      - name: Verify bundle stats file exists
        run: |
          if [ -f dist/public/bundle-stats.html ]; then
            echo "Bundle stats file created at dist/public/bundle-stats.html"
            cp dist/public/bundle-stats.html bundle-stats.html
          elif [ -f dist/bundle-stats.html ]; then
            echo "Bundle stats file created at dist/bundle-stats.html"
            cp dist/bundle-stats.html bundle-stats.html
          elif [ -f bundle-stats.html ]; then
            echo "Bundle stats file created at bundle-stats.html"
          else
            echo "Error: bundle-stats.html not found in any expected location"
            exit 1
          fi

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}
          path: bundle-stats.html
          retention-days: 30

      - name: Get bundle size
        id: bundle-size
        run: |
          if [ -d dist/public ]; then
            BUNDLE_SIZE=$(du -sh dist/public | cut -f1)
          else
            BUNDLE_SIZE=$(du -sh dist | cut -f1)
          fi
          echo "Bundle size: $BUNDLE_SIZE"
          echo "size=$BUNDLE_SIZE" >> $GITHUB_OUTPUT

      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const bundleSize = '${{ steps.bundle-size.outputs.size }}';
            const comment = `## Bundle Size Analysis

            üì¶ **Total Bundle Size:** \`${bundleSize}\`

            üìä [View detailed bundle analysis](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Download the \`bundle-stats.html\` artifact to see an interactive visualization.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check bundle size threshold
        run: |
          if [ -d dist/public ]; then
            BUNDLE_SIZE_KB=$(du -sk dist/public | cut -f1)
          else
            BUNDLE_SIZE_KB=$(du -sk dist | cut -f1)
          fi
          MAX_SIZE_KB=5000

          if [ "$BUNDLE_SIZE_KB" -gt "$MAX_SIZE_KB" ]; then
            echo "‚ö†Ô∏è Warning: Bundle size ($BUNDLE_SIZE_KB KB) exceeds threshold ($MAX_SIZE_KB KB)"
            echo "Consider optimizing your bundle by:"
            echo "  - Code splitting"
            echo "  - Tree shaking"
            echo "  - Lazy loading components"
            echo "  - Removing unused dependencies"
            exit 1
          else
            echo "‚úÖ Bundle size is within acceptable limits"
          fi
