# Stale Issues and PRs Management - Automatically manages inactive items
name: Manage Stale Items

on:
  schedule:
    # Run daily at 1 AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  stale:
    name: Mark and Close Stale Items
    runs-on: ubuntu-latest
    
    steps:
      - name: Manage stale issues and PRs
        uses: actions/stale@v8
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          
          # Issue configuration
          stale-issue-message: |
            üëã This issue has been automatically marked as stale because it has not had recent activity. 
            
            It will be closed in 7 days if no further activity occurs. If this issue is still relevant, please:
            - Comment with any updates or additional information
            - Add the `keep-open` label to prevent auto-closure
            
            Thank you for your contribution to ChefSpAIce! üç≥
            
          close-issue-message: |
            This issue has been automatically closed due to inactivity. 
            
            If you believe this issue is still relevant, please:
            - Open a new issue with updated information
            - Reference this closed issue for context
            
            Thank you for understanding! üôè
            
          stale-issue-label: 'stale'
          exempt-issue-labels: 'keep-open,bug,security,high-priority,in-progress'
          days-before-issue-stale: 30
          days-before-issue-close: 7
          
          # PR configuration
          stale-pr-message: |
            üëã This pull request has been automatically marked as stale because it has not had recent activity.
            
            It will be closed in 14 days if no further activity occurs. To keep this PR open:
            - Push new commits
            - Comment with status updates
            - Resolve merge conflicts
            - Add the `keep-open` label
            
            If you're still working on this, please let us know! üí™
            
          close-pr-message: |
            This pull request has been automatically closed due to inactivity.
            
            If you'd like to continue work on this:
            - Reopen the PR if you have push access
            - Open a new PR with your changes
            - Reference this closed PR for context
            
            Thank you for your contribution! üöÄ
            
          stale-pr-label: 'stale'
          exempt-pr-labels: 'keep-open,work-in-progress,awaiting-review,ready-to-merge'
          days-before-pr-stale: 14
          days-before-pr-close: 14
          
          # Operation limits
          operations-per-run: 50
          
          # Additional configuration
          remove-stale-when-updated: true
          delete-branch: false
          start-date: '2024-01-01T00:00:00Z'
          
          # Exempt milestones
          exempt-milestones: 'v1.0.0,v2.0.0'
          exempt-all-milestones: false
          
          # Assignees
          exempt-all-assignees: false
          exempt-assignees: 'dependabot[bot],renovate[bot]'
          
          # Draft PRs
          exempt-draft-pr: true
          
          # Sort order
          ascending: true
          
          # Debug mode (set to true for testing)
          debug-only: false

  abandoned-drafts:
    name: Close Abandoned Draft PRs
    runs-on: ubuntu-latest
    
    steps:
      - name: Close old draft PRs
        uses: actions/github-script@v7
        with:
          script: |
            const daysUntilClose = 30;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysUntilClose);
            
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              draft: true,
              sort: 'updated',
              direction: 'asc'
            });
            
            for (const pr of pullRequests) {
              const lastUpdated = new Date(pr.updated_at);
              
              if (lastUpdated < cutoffDate) {
                // Add comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `This draft PR has been inactive for ${daysUntilClose} days and will be closed. If you're still working on this, please convert it to "Ready for review" or push new commits.`
                });
                
                // Close PR
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  state: 'closed'
                });
                
                console.log(`Closed draft PR #${pr.number}: ${pr.title}`);
              }
            }

  needs-response:
    name: Mark Issues Needing Response
    runs-on: ubuntu-latest
    
    steps:
      - name: Label issues awaiting response
        uses: actions/github-script@v7
        with:
          script: |
            const daysUntilNeedsResponse = 3;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysUntilNeedsResponse);
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'awaiting-user-response'
            });
            
            for (const issue of issues) {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                since: cutoffDate.toISOString()
              });
              
              // Check if issue creator has responded
              const creatorResponded = comments.data.some(
                comment => comment.user.login === issue.user.login
              );
              
              if (!creatorResponded) {
                // Add needs-response label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['needs-response']
                });
                
                console.log(`Added needs-response label to issue #${issue.number}`);
              } else {
                // Remove needs-response label if creator responded
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: 'needs-response'
                  });
                  
                  console.log(`Removed needs-response label from issue #${issue.number}`);
                } catch (error) {
                  // Label might not exist, ignore
                }
              }
            }