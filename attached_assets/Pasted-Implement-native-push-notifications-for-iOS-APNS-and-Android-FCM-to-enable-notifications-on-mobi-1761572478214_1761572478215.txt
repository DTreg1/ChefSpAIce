Implement native push notifications for iOS (APNS) and Android (FCM)
to enable notifications on mobile apps.

PREREQUISITES:
1. Get Firebase Cloud Messaging credentials:
- Create Firebase project at console.firebase.google.com
- Add Android app to project
- Download google-services.json
- Get Server Key from Cloud Messaging settings
- Set FCM_SERVER_KEY environment variable

2. Get Apple Push Notification Service credentials:
- Enroll in Apple Developer Program
- Create App ID with Push Notifications capability
- Create APNs Authentication Key (.p8 file)
- Note Key ID and Team ID
- Set APNS_KEY_ID, APNS_TEAM_ID, APNS_KEY_FILE environment variables

BACKEND IMPLEMENTATION:
1. Install dependencies:
npm install firebase-admin @parse/node-apn

2. Create separate service modules:

A. server/services/fcm.service.ts (Android):
- Initialize Firebase Admin SDK
- sendFcmNotification(token: string, payload: NotificationPayload)
- validateFcmToken(token: string)
- Handle FCM-specific payload formatting

B. server/services/apns.service.ts (iOS):
- Initialize APNs connection
- sendApnsNotification(token: string, payload: NotificationPayload)
- validateApnsToken(token: string)
- Handle APNs-specific payload formatting (alert, badge, sound)

3. Update push-notification.service.ts:
- Remove TODO comment at line 72-75
- Implement native platform handlers:

if (token.platform === 'web') {
// Existing web push code
} else if (token.platform === 'ios') {
await ApnsService.sendNotification(token.token, payload);
} else if (token.platform === 'android') {
await FcmService.sendNotification(token.token, payload);
}

4. Enhance token registration:
- Update POST /api/push/subscribe endpoint
- Accept platform field: 'web' | 'ios' | 'android'
- Store device-specific token format
- Validate token format based on platform

PAYLOAD FORMATTING:
1. FCM (Android) format:
{
token: "fcm_device_token",
notification: {
title: payload.title,
body: payload.body,
icon: payload.icon
},
data: payload.data,
android: {
priority: "high",
notification: {
sound: "default",
clickAction: "FLUTTER_NOTIFICATION_CLICK"
}
}
}

2. APNs (iOS) format:
{
alert: {
title: payload.title,
body: payload.body
},
badge: payload.badge,
sound: "default",
payload: payload.data,
topic: "com.chefspaice.app"
}

FRONTEND INTEGRATION:
1. Update client/src/utils/pushNotifications.ts:
- Remove TODO at line 41
- Implement sendTokenToBackend():

private async sendTokenToBackend(token: string) {
const platform = Capacitor.getPlatform(); // 'ios' | 'android' | 'web'
const deviceInfo = await Device.getInfo();

await apiRequest('POST', '/api/push/subscribe', {
token,
platform,
deviceId: deviceInfo.identifier,
deviceModel: deviceInfo.model,
osVersion: deviceInfo.osVersion
});
}

2. Handle platform-specific permissions:
- iOS: Request permissions on first launch
- Android: Permissions granted by default
- Handle permission denied scenarios

CAPACITOR NATIVE SETUP:
1. iOS (ios/App/App/):
- Add Push Notification capability in Xcode
- Configure APNs in App ID
- Add .p8 key file to project
- Update Info.plist with notification permissions

2. Android (android/app/):
- Add google-services.json to android/app/
- Update build.gradle with FCM dependencies
- Configure notification channels
- Add notification icons (res/drawable)

ERROR HANDLING:
1. Token validation errors:
- Invalid token format
- Expired tokens
- Unregistered tokens
- Handle 410 Gone responses

2. Platform-specific errors:
- FCM: InvalidRegistration, NotRegistered, MessageTooBig
- APNs: BadDeviceToken, DeviceTokenNotForTopic, Unregistered
- Deactivate invalid tokens automatically

3. Retry logic:
- Implement exponential backoff
- Queue failed notifications
- Alert admins of persistent failures

TESTING CHECKLIST:
- Test iOS notifications on physical device
- Test Android notifications on physical device
- Verify notifications appear when app is:
- In foreground
- In background
- Closed completely
- Test notification actions (tap, dismiss)
- Verify badge counts update correctly
- Test with multiple devices per user
- Check token refresh handling

SECURITY:
- Store APNs .p8 key securely (not in git)
- Rotate keys periodically
- Validate all incoming tokens
- Rate limit notification sending
- Encrypt sensitive notification data
