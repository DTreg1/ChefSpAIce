# ChefSpAIce

## Overview
ChefSpAIce is a mobile application designed to manage kitchen inventory, reduce food waste, and promote sustainable eating habits. It offers AI-powered recipe generation, meal planning, and shopping list management. The project aims to provide a comprehensive solution for efficient food management through intelligent features and a focus on sustainability.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The application is built with React Native and Expo, utilizing React Navigation, React Native Reanimated, and TanStack React Query for the frontend. It features an iOS 26 Liquid Glass Design aesthetic with light/dark mode and a centralized design system, employing a local-first data approach with AsyncStorage for offline persistence.

The backend is powered by Express.js and Node.js, using Drizzle ORM with PostgreSQL. It includes a custom authentication system, a Real-Time Sync Manager with optimistic updates, and AI integration via OpenAI API for equipment-aware and inventory-specific recipe generation, fuzzy matching, and shelf-life suggestions.

Key features include a root stack navigator with five-tab bottom navigation, custom authentication with social login and session tokens, and a trial and subscription system with guest account functionality and data migration. An onboarding flow guides new users, and all authenticated user data syncs to PostgreSQL with retry logic and conflict resolution. AI integration extends to kitchen assistant chat, smart shelf-life suggestions, and push notifications for expiring items. The Scan Hub supports barcode, nutrition label, recipe, and grocery receipt scanning (using OpenAI Vision) with AI food identification. Other features include Instacart integration, Siri Shortcuts, biometric authentication, deep linking, and comprehensive accessibility. The system also implements structured logging, response compression, and a delta sync mechanism to optimize performance and reduce API payload sizes. All API responses follow a consistent envelope for better error handling and data consumption.

## External Dependencies
- **OpenAI API**: AI-powered recipe generation and conversational assistance.
- **USDA FoodData Central API**: Comprehensive nutrition data lookup.
- **OpenFoodFacts API**: Open-source product information.
- **PostgreSQL**: Primary relational database.
- **Replit Object Storage**: Cloud file storage.
- **Instacart Connect API**: Grocery shopping integration.
- **expo-camera**: Barcode scanning.
- **@react-native-async-storage/async-storage**: Persistent local storage.

## Data Sync Architecture
- **Strategy**: Local-first with cloud backup. Data is written to AsyncStorage immediately for instant UI response, then synced to PostgreSQL asynchronously.
- **Sync triggers**: (1) On app foreground — `resumeSync()` drains the queue and flushes pending preferences/profile. (2) After local mutations — `queueChange()` debounces for 2 seconds, then calls `processSyncQueue()`. (3) Periodic — a 60-second network health check detects connectivity restoration and auto-drains the queue. (4) Manual — `fullSync()` can be called explicitly (pull-to-refresh, after chat actions).
- **Conflict resolution**: Last-write-wins based on `updatedAt` timestamps. On PUT, the server compares the client's `updatedAt` against the existing row. If the client timestamp is older or equal, the server responds `{ operation: "skipped", reason: "stale_update" }`. The client treats this as a 409 conflict and marks the queue item as fatal. On POST (create), the server upserts without timestamp comparison — client data always wins for new items.
- **Offline behavior**: Changes are persisted in the sync queue (AsyncStorage) and survive app restarts. Network status is inferred heuristically (3+ consecutive fetch failures = offline; one success = online). While offline, `processSyncQueue()` is a no-op. Failed items retry with exponential back-off (2^n seconds, max 30 s). After 5 retries or a 4xx status, items are marked fatal and the user is alerted.
- **Queue coalescing**: When a new change targets an item already in the queue (matched by `dataType` + `data.id`): delete always replaces; update-after-create keeps "create" with latest data; otherwise the newer entry replaces the older.
- **Full sync flow**: Push-then-pull. (1) Drain outbound queue (local→server). (2) GET /api/auth/sync with `lastSyncedAt` for delta sync. Server returns only sections updated since that timestamp. Each returned section overwrites local storage entirely — server is source of truth after pull.
- **Data sections**: inventory, recipes, mealPlans, shoppingList (per-item sync via individual POST/PUT/DELETE endpoints), plus preferences and userProfile (batch sync via POST /api/auth/sync).
- **Deletion handling**: Inventory uses soft delete (sets `deletedAt`, syncs as "update"); after 30 days, a permanent purge sends "delete". All other data types use immediate hard delete.
- **Known edge case**: If a user edits the same item on two devices while both are offline, the device that syncs last wins. The earlier device's changes are silently overwritten. The losing device sees a conflict alert but the server version is not rolled back.

## Recent Changes
- **Soft Delete for Inventory (2026-02-07)**: Inventory items now use soft delete instead of permanent deletion. When a user deletes an item, `deletedAt` is set to the current timestamp. Items remain recoverable for 30 days via the "Recently Deleted" section in Settings. The `getInventory()` method filters out soft-deleted items automatically. A cleanup function runs on app startup to permanently purge items older than 30 days. Soft deletes sync to the server as "update" operations (setting `deleted_at` column on `user_inventory_items` table). The server GET sync endpoint filters out soft-deleted items with `isNull(deletedAt)`.
- **Database Normalization (2026-02-07)**: Migrated inventory, recipes, meal plans, shopping lists, and cookware from JSONB blobs in `user_sync_data` to separate relational tables (`user_inventory_items`, `user_saved_recipes`, `user_meal_plans`, `user_shopping_items`, `user_cookware_items`) with proper foreign keys and indexes. Timestamp-based conflict resolution on all sync operations.
- **GDPR Data Export (2026-02-07)**: Added `GET /api/user/export-data` endpoint and "Download My Data" button in Settings for GDPR-compliant personal data export.
- **Payment Grace Period (2026-02-07)**: Added 7-day grace period for failed payments. When a payment fails, the subscription is marked `past_due` with a dedicated `payment_failed_at` timestamp column. Users retain access for 7 days while seeing a warning banner and receiving push notifications (immediate, 3-day, and 1-day reminders). After 7 days, API access is blocked with a `payment_required` error. The `/api/subscriptions/me` endpoint returns `paymentFailedAt`, `gracePeriodEnd`, and `graceDaysRemaining` fields. When payment succeeds, `payment_failed_at` is cleared. The `requireSubscription` middleware allows `past_due` status within the grace window.
- **Referral Credit System (2026-02-07)**: Overhauled referral rewards. Referred friends receive 14-day trial (7 base + 7 bonus). Referrers earn 1 credit per successful referral; 3 credits auto-redeem for 1 month free (30-day extension on trial or subscription). Credits tracked via `bonusGranted` boolean on `referrals` table rows. `checkAndRedeemReferralCredits()` in subscriptionService handles batch redemption. Stats endpoint (`GET /api/referral/code`) returns `creditsRemaining`, `rewardsEarned`, `creditsNeededForReward`. Public validation endpoint at `GET /api/referral/validate/:code`.
- **Trial Countdown & Milestone Notifications (2026-02-07)**: Added visible trial countdown in the Inventory screen header via compact `TrialStatusBadge` (green 7-4 days, yellow 3-2 days, red 1-0 days). `useTrialStatus` hook now recalculates on app foreground via AppState listener. Both local and server trial data are used (server `trialDaysRemaining` takes priority). `TrialMilestoneBanner` shows a non-dismissible warning at 2-3 days remaining in the inventory list header. `TrialExpiringModal` shows at 1 day remaining with Pro feature list and Subscribe/Later buttons (dismiss state persisted in AsyncStorage). Existing `TrialEndedModal` handles 0-day expiry via `useSubscription` provider.
- **FREE Tier (2026-02-07)**: Added a FREE tier to increase user acquisition and referral spread. Three-tier system: Free ($0), Basic ($4.99/mo), Pro ($9.99/mo). FREE tier limits: 10 pantry items, 2 AI recipes/month, 3 cookware items, no premium features. New users default to FREE. `requireSubscription` middleware allows FREE users through without a Stripe subscription record. When trial expires or subscription is canceled, users fall back to FREE instead of being blocked. `useSubscription` hook treats FREE as always-active (`isFreeUser` flag added). `UpgradePrompt` shows context-aware messaging ("Upgrade to Basic or Pro" for FREE users, "Upgrade to Pro" for BASIC). Subscription screen displays 3-tier comparison with Free card. Hardcoded cookware limits in CookwareScreen and OnboardingScreen replaced with dynamic entitlements.
- **Atomic Database Transactions (2026-02-07)**: Wrapped all multi-step database operations in Drizzle `db.transaction()` blocks to ensure atomicity. Covered operations: user registration (user insert + session + sync data + referral), referral application (insert referral + update user), referral credit redemption (mark referrals + extend subscription + update user), subscription tier changes (`downgradeUserTier`, `setTrialExpiration`, `ensureTrialSubscription`, `expireTrialSubscription`), and both account deletion routes (all related table deletes). External service calls (Stripe, image deletion) remain outside transactions. Drizzle auto-rolls back on thrown exceptions.
- **Responsive Tablet Layouts (2026-02-08)**: Added `useDeviceType` hook (`client/hooks/useDeviceType.ts`) that returns `isPhone`, `isTablet`, `isLargeTablet` based on window width breakpoints (768px, 1024px). InventoryScreen renders storage location groups in 2-column grid on tablets. RecipesScreen adapts from 2 columns (phone) to 3 (tablet) or 4 (large tablet) with flexible card widths. MealPlanScreen shows all 7 days side-by-side in a horizontal scroll on tablets instead of the day selector + single day view. Web landing page now includes a dismissible "Download the App" banner with App Store and Play Store badges and "Web app coming soon" messaging.
- **Session Metadata & Active Sessions (2026-02-07)**: Added `user_agent` and `ip_address` columns to `user_sessions` table. Session creation (register/login) now stores the request's user-agent and IP. Auth middleware (`server/middleware/auth.ts`) logs a warning when a session's stored user-agent doesn't match the current request's user-agent (soft check, no blocking). Three new API endpoints: `GET /api/auth/sessions` (list active sessions with `isCurrent` flag), `DELETE /api/auth/sessions/:sessionId` (revoke specific session, cannot revoke current), `DELETE /api/auth/sessions` (revoke all other sessions). New `SettingsActiveSessions` component in Settings shows device name (parsed from UA), masked IP, relative time, current session badge, and revoke controls. Password reset rate limiter (3 attempts/hour) at `POST /api/auth/forgot-password` and `POST /api/auth/reset-password` with email enumeration prevention.